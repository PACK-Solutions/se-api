services:

    app:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: se-api
        environment:
            PORT: 8080
            DATABASE_URL: ${DATABASE_URL}
            DATABASE_USER: ${DATABASE_USER}
            DATABASE_PASSWORD: ${DATABASE_PASSWORD}
        ports:
            - "8080:8080"
        depends_on:
            postgres:
                condition: service_healthy

    postgres:
        image: postgres:18
        container_name: postgres
        command: [ "postgres", "-c", "shared_preload_libraries=pg_stat_statements" ]
        environment:
            POSTGRES_DB: suite_epargne
            POSTGRES_USER: ${DATABASE_USER}
            POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
        ports:
            - "5432:5432"
        volumes:
            - postgres-data:/var/lib/postgresql
            - ./postgres-init.sql:/docker-entrypoint-initdb.d/postgres-init.sql
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U postgres" ]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 10s

volumes:
    postgres-data:
